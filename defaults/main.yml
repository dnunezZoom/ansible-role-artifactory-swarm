---
# postgres setings
artifactory_postgres_user: artifactory
artifactory_postgres_pass: artifactorypass
artifactory_postgres_db: artifactory

# artifactory settings
artifactory_javaopts: "-Xmx4g"

# docker stack settings
artifactory_remove: false
artifactory_stack_name: artifactory   # no spaces
artifactory_network_name: net         # docker prepends stack name
artifactory_networks: []              # additional networks

artifactory_image: "docker.bintray.io/jfrog/artifactory-pro"
artifactory_image_tag: "latest"
artifactory_env_vars: {}
artifactory_deploy_labels: ~
artifactory_datapath: /opt/artifactory  # a subdirectory for af is created and used automatically

artifactory_postgres_image: "docker.bintray.io/postgres"
artifactory_postgres_image_tag: "9.5.2"
artifactory_postgres_env_vars: {}
artifactory_postgres_deploy_labels: ~
artifactory_postgres_datapath: /opt/artifactory/postgresql/data

artifactory_url: "artifactory.*"
artifactory_proxy_port: 8082
artifactory_proxy_image: "nginx"
artifactory_proxy_image_tag: "alpine"
artifactory_proxy_env_vars: {}
artifactory_proxy_networks: []
artifactory_proxy_config: |
  ### defaults to NO SSL termination. expectation is that is handled separately.
  ## add ssl entries when https has been set in config
  # ssl_certificate      /moo/cert.crt;
  # ssl_certificate_key  /moo/cert.key;
  # ssl_session_cache shared:SSL:1m;
  # ssl_prefer_server_ciphers   on;
  ## server configuration
  server {
      listen {{artifactory_proxy_port}};
      server_name ~(?<repo>.+)\.{{ artifactory_url }} {{ artifactory_url }};
      ## Application specific logs
      access_log /var/log/nginx/artifactory-access.log combined;
      error_log /var/log/nginx/artifactory-error.log;
      rewrite ^/$ /artifactory/webapp/ redirect;
      rewrite ^/artifactory/?(/webapp)?$ /artifactory/webapp/ redirect;
      rewrite ^/(v1|v2)/(.*) /artifactory/api/docker/$repo/$1/$2;
      chunked_transfer_encoding on;
      client_max_body_size 0;
      location /artifactory/ {
          if ($http_x_forwarded_proto = '') {
            set $http_x_forwarded_proto  $scheme;
          }
          # if ($http_x_forwarded_proto != 'https') {
          #   rewrite ^ https://$host$request_uri? permanent;
          # }
          proxy_read_timeout  900;
          proxy_pass_header   Server;
          proxy_cookie_path   ~*^/.* /;
          # the following URLs refer to the Docker link and native port
          if ( $request_uri ~ ^/artifactory/(.*)$ ) {
              proxy_pass          http://artifactory:8081/artifactory/$1;
          }
          proxy_pass          http://artifactory:8081/artifactory/;
          proxy_set_header    X-Artifactory-Override-Base-Url http://$host:{{artifactory_proxy_port}}/artifactory; #https://$host/artifactory;
          proxy_set_header    X-Forwarded-Port  80; #443;
          proxy_set_header    X-Forwarded-Proto http; #https;
          proxy_set_header    Host              $http_host;
          proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
      }
      location /artifactory/api/system/ping {
          # same as /artifactory, but without the SSL redirect
          proxy_read_timeout  900;
          proxy_pass_header   Server;
          proxy_cookie_path   ~*^/.* /;
          # the following URLs refer to the Docker link and native port
          if ( $request_uri ~ ^/artifactory/(.*)$ ) {
              proxy_pass          http://artifactory:8081/artifactory/$1;
          }
          proxy_pass          http://artifactory:8081/artifactory/;
          proxy_set_header    X-Artifactory-Override-Base-Url https://$host:{{artifactory_proxy_port}}/artifactory; #https://$host/artifactory;
          proxy_set_header    X-Forwarded-Port  80; #443;
          proxy_set_header    X-Forwarded-Proto http; #https;
          proxy_set_header    Host              $http_host;
          proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
      }
  }
